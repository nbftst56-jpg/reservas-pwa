<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Controle de Reservas - Temporada 2025/2026</title>
  <style>
  /* Tamanho mínimo para toque confortável */
  button, .dia {
    min-width: 48px;
    min-height: 48px;
    font-size: 16px;
    padding: 8px;
    margin: 6px 0;
  }

  /* Layout responsivo básico */
  @media (max-width: 480px) {
    .painel, .filtros, .controles {
      flex-direction: column;
      width: 100%;
    }

    .dropdown-content button {
      font-size: 16px;
      padding: 12px;
    }

    .mes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 4px;
    }

    .dia {
      font-size: 14px;
      padding: 10px;
    }
  }




    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
      margin: 0;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .main-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .left-panel,
    .right-panel {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 300px;
    }

    .legenda,
    .data-management,
    .controls {
      margin-bottom: 20px;
    }

    .data-management h3,
    .controls h3 {
      color: #555;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .legenda ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .legenda li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      font-size: 14px;
    }

    .exemplo {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 4px;
      display: inline-block;
      vertical-align: middle;
    }

    .exemplo.entrada {
      background-color: #d0eaff;
    }

    .exemplo.saida {
      background-color: #ffd6d6;
    }

    .exemplo.dupla {
      background: linear-gradient(135deg, #ffd6d6 50%, #d0eaff 50%);
    }

    .exemplo.hospedado {
      background-color: #c8f7c5;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .file-operations {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-items: center;
    }

    .file-operations label {
      margin-bottom: 0;
    }

    .file-operations button {
      width: 100%;
    }

    .controls label,
    .controls select,
    .controls .checkbox-group {
      font-size: 16px;
      margin-bottom: 8px;
      display: block;
    }

    .controls select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    
    .controls .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .controls .checkbox-group input {
      margin-right: 8px;
    }

    .controls button {
      padding: 10px 20px;
      font-size: 16px;
      margin-bottom: 10px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s ease;
      width: 100%;
    }

    .controls button:hover {
      background-color: #0056b3;
    }

    .controls button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .seguranca-ativada {
      background-color: #dc3545 !important;
    }
    .seguranca-ativada:hover {
      background-color: #c82333 !important;
    }

    .data-management button {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .data-management button:hover {
      background-color: #5a6268;
    }

    hr {
      border: 0;
      border-top: 1px solid #eee;
      margin: 20px 0;
    }

    .unidade {
      margin-bottom: 40px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .mes {
      margin-bottom: 20px;
    }

    .mes h3 {
      margin-bottom: 10px;
      color: #444;
    }

    .dias {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 5px;
    }

    .dia {
      background: #e0e0e0;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      min-height: 60px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.1);
      position: relative;
      transition: opacity 0.3s, transform 0.2s;
    }
    
    .dia.filtered-out {
        opacity: 0.3;
    }
    .dia.filtered-in {
        transform: scale(1.05);
        box-shadow: 0 0 10px #007bff;
    }
    .dia.seguranca-ativada {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .dia strong {
      font-size: 14px;
      margin-bottom: 5px;
    }

    .dia div {
      margin: 2px 0;
      font-size: 10px;
      line-height: 1.2;
    }

    .entrada {
      background-color: #d0eaff !important;
    }

    .saida {
      background-color: #ffd6d6 !important;
    }

    .hospedado {
      background-color: #c8f7c5 !important;
    }

    .dupla {
      background: linear-gradient(135deg, #ffd6d6 50%, #d0eaff 50%) !important;
    }

    .dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .dropbtn {
        width: 100%;
        padding: 10px 15px;
        font-size: 16px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 100;
      width: 100%;
      left: 0;
      right: 0;
    }

    .dropdown-content button {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      background-color: #f1f1f1;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }

    .dropdown-content button:hover {
      background-color: #ddd;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    #tooltip {
      display: none;
      position: absolute;
      z-index: 9999;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      pointer-events: none;
      left: 0;
      top: 0;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 700px;
      position: relative;
    }

    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #555;
    }
    
    .modal-content h3 {
        color: #555;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    /* --- ESTILOS PARA ABAS E RELATÓRIOS --- */
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .tab-btn {
      padding: 10px 15px;
      cursor: pointer;
      border: none;
      background-color: transparent;
      border-bottom: 3px solid transparent;
      font-size: 16px;
    }
    .tab-btn.active {
      border-bottom: 3px solid #007bff;
      font-weight: bold;
    }
    .report-content {
      display: none;
    }
    .report-content.active {
      display: block;
      max-height: 60vh; 
      overflow-y: auto;
      padding-right: 10px;
    }
    .unidade-relatorio {
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    .unidade-relatorio:last-child {
      border-bottom: none;
    }
    .unidade-relatorio h4 {
      color: #007bff;
      margin-top: 0;
    }
    .unidade-relatorio p {
      font-size: 14px;
      line-height: 1.5;
      word-break: break-all;
    }
    .mes-relatorio {
        margin-bottom: 15px;
    }
    .mes-relatorio h5 {
        text-align: center;
        margin: 5px 0;
    }
    .dias-relatorio {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        font-size: 12px;
    }
    .dia-relatorio {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 30px;
        background-color: #f0f0f0;
        border-radius: 4px;
    }
    .dia-relatorio.header {
        font-weight: bold;
        background-color: transparent;
    }
    .dia-relatorio.noite-ocupada {
        background-color: #ffd6d6;
        color: #a22;
        font-weight: bold;
    }
    .dia-relatorio.troca {
        background-color: #ffc107;
        color: #7d5900;
        font-weight: bold;
    }
    .dia-relatorio.checkout-apenas {
        background: linear-gradient(135deg, #f0f0f0 49%, #ffe8e8 51%);
    }
    /* --- FIM DOS ESTILOS --- */

    @media print {
      body > *:not(#modalRelatorio) {
        display: none !important;
      }
      #modalRelatorio {
        display: block !important;
        position: relative;
        left: 0;
        top: 0;
        max-width: none;
        width: 100%;
        height: auto;
        background: none;
        box-shadow: none;
      }
      .modal-overlay {
        background: none;
      }
      .modal-content, .report-content, .unidade-relatorio, .mes-relatorio {
        visibility: visible !important;
      }
      .modal-close-btn, .modal-tabs, .print-btn {
        display: none !important;
      }
      .report-content:not(.active) {
        display: none !important;
      }
      .report-content.active {
        display: block !important;
        max-height: none;
        overflow-y: visible;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
    }
  </style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js")
        .then(reg => console.log("Service Worker registrado:", reg))
        .catch(err => console.error("Erro ao registrar SW:", err));
    });
  }
</script>

</head>
<body>
  <h1>Controle de Reservas - Temporada 2025/2026</h1>

  <div class="main-container">
    <div class="left-panel">
      <div class="data-management">
        <h3>Gerenciamento de Dados:</h3>
        <div class="dropdown">
          <button class="dropbtn">⚙️ Gerenciar Dados Locais</button>
          <div class="dropdown-content">
            <button id="salvarLocalmenteBtn">💾 Salvar Localmente</button>
            <button id="limparDadosLocaisBtn">🧹 Limpar Dados Locais</button>
            <div style="padding: 12px 16px; background-color: #f1f1f1;">
              <label for="autoBackupToggle" style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="autoBackupToggle" style="margin-right: 10px;">
                Backup automático
              </label>
            </div>
          </div>
        </div>
        <hr>
      </div>
      
      <div class="file-operations">
        <div class="dropdown">
          <button class="dropbtn">📥/📤 Importar / Exportar</button>
          <div class="dropdown-content">
            <h4 style="padding: 10px 16px; margin: 0; background: #eee;">Importar</h4>
            <button id="importarClientesBtn">Importar Clientes (.txt)</button>
            <button id="importarReservasBtn">Importar Reservas (.json)</button>
            <hr style="margin: 5px 0;">
            <h4 style="padding: 10px 16px; margin: 0; background: #eee;">Exportar</h4>
            <button id="exportarClientesBtn">Exportar Clientes (.txt)</button>
            <button id="exportarReservasTXTBtn">Exportar Reservas (.txt)</button>
            <button id="exportarReservasJSONBtn">Exportar Reservas (.json)</button>
          </div>
        </div>
        <button id="segurancaBtn">🔒 Segurança Desativada</button>
        <input type="file" id="importarClientesInput" accept=".txt" style="display: none;">
        <input type="file" id="importarReservasInput" accept=".json" style="display: none;">
      </div>
    </div>

    <div class="right-panel">
      <div class="controls">
        <h3>Controles de Visualização:</h3>
        <button id="ajudaBtn">❓ Ajuda & Legenda</button>
        <button id="mostrarTudoBtn">🔄 Mostrar Tudo / Limpar Filtros</button>
        <button id="gerarRelatorioBtn">📊 Gerar Relatório de Ocupação</button>

        <div class="filter-group">
          <div style="display: flex; align-items: flex-end; gap: 10px; margin-bottom: 15px;">
            <div style="flex-grow: 1;">
              <label for="clienteSelect">Filtrar por Cliente:</label>
              <select id="clienteSelect">
                <option value="">-- Todos os Clientes --</option>
              </select>
            </div>
            <div class="dropdown" style="width: auto;">
              <button class="dropbtn" style="width: auto; padding: 8px 15px;">⚙️ Ações</button>
              <div class="dropdown-content">
                <button id="adicionarClienteBtn">➕ Adicionar Novo Cliente</button>
                <button id="editarClienteBtn" disabled>✏️ Editar Selecionado</button>
                <button id="removerClienteBtn" disabled>❌ Remover Selecionado</button>
              </div>
            </div>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="filtroResvCheckbox">
            <label for="filtroResvCheckbox" style="display: inline; margin-bottom: 0;">Filtrar por Status "Resv"</label>
          </div>
          <label for="unidadeSelect">Filtrar por Unidade:</label>
          <select id="unidadeSelect">
            <option value="">-- Todas as Unidades --</option>
            <option value="UN01">UN01</option>
            <option value="UN02">UN02</option>
            <option value="UN03">UN03</option>
          </select>

          <label for="mesSelect">Filtrar por Mês:</label>
          <select id="mesSelect">
            <option value="">-- Todos os Meses --</option>
            <option value="Novembro">Novembro</option>
            <option value="Dezembro">Dezembro</option>
            <option value="Janeiro">Janeiro</option>
            <option value="Fevereiro">Fevereiro</option>
            <option value="Março">Março</option>
            <option value="Abril">Abril</option>
            <option value="Maio">Maio</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="calendarios"></div>
  <div id="tooltip"></div>

  <div id="modalAjuda" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3>🎨 Legenda:</h3>
      <ul class="legenda">
        <li><span class="exemplo entrada"></span> Entrada</li>
        <li><span class="exemplo saida"></span> Saída</li>
        <li><span class="exemplo dupla"></span> Entrada/Saída</li>
        <li><span class="exemplo hospedado"></span> Hospedado</li>
      </ul>
      <hr>
      <h3>🖱️ Lógica de Cliques:</h3>
      <ul>
        <li>1º Clique → 🔵 Marca como Entrada</li>
        <li>2º Clique → 🟢 Marca como Hospedado</li>
        <li>3º Clique → 🔴 Marca como Saída</li>
        <li>4º Clique → ⚪ Limpa a marcação do cliente atual</li>
      </ul>
      <p><strong>Observação:</strong> Para limpar todas as marcações de um dia (de todos os clientes), use o botão direito do mouse ou dê um duplo clique no dia.</p>
    </div>
  </div>

  <div id="modalRelatorio" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3>📊 Relatório de Ocupação</h3>
      
      <div class="modal-tabs">
        <button class="tab-btn" data-target="relatorioConteudoTexto">Resumo em Texto</button>
        <button class="tab-btn" data-target="relatorioConteudoVisual">Visualização em Calendário</button>
      </div>

      <div id="relatorioConteudoTexto" class="report-content">
        </div>
      <div id="relatorioConteudoVisual" class="report-content">
        </div>

      <div style="text-align: right; margin-top: 20px;">
        <button class="print-btn" onclick="window.print()">🖨️ Imprimir Relatório</button>
      </div>
    </div>
  </div>

  <div id="modalCliente" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <span class="modal-close-btn">&times;</span>
      <h3 id="modalClienteTitulo">Adicionar Novo Cliente</h3>
      <form id="formCliente">
        <input type="hidden" id="clienteOriginalNomeInput">
        <div style="margin-bottom: 15px;">
          <label for="clienteNomeInput">Nome:</label>
          <input type="text" id="clienteNomeInput" required style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label for="clienteWhatsInput">WhatsApp (com DDI):</label>
          <input type="text" id="clienteWhatsInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label for="clientePaisInput">País:</label>
          <input type="text" id="clientePaisInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label for="clienteTempoInput">Tempo de Estadia:</label>
          <input type="text" id="clienteTempoInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label for="clienteUnidadeInput">Unidade Preferencial:</label>
          <input type="text" id="clienteUnidadeInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label for="clienteStatusInput">Status (ex: OK, RESV):</label>
          <input type="text" id="clienteStatusInput" style="width: 100%; padding: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        <button type="submit" id="salvarClienteBtn" style="width: 100%; padding: 12px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Salvar Cliente</button>
      </form>
    </div>
  </div>

<script>
(function() {
    // VARIÁVEIS GLOBAIS E REFERÊNCIAS DO DOM
    let clientes = [];
    let clienteSelecionado = null;
    let segurancaAtivada = false;
    const LOCAL_STORAGE_KEY_RESERVAS = 'dadosReservasTemporada2025_2026';
    const LOCAL_STORAGE_KEY_CLIENTES = 'clientesTemporada2025_2026';
    // Seletores de elementos do DOM
    const clienteSelect = document.getElementById("clienteSelect");
    const unidadeSelect = document.getElementById("unidadeSelect");
    const mesSelect = document.getElementById("mesSelect");
    const container = document.getElementById("calendarios");
    // Botões e Inputs
    const importarClientesBtn = document.getElementById("importarClientesBtn");
    const importarClientesInput = document.getElementById("importarClientesInput");
    const importarReservasBtn = document.getElementById("importarReservasBtn");
    const importarReservasInput = document.getElementById("importarReservasInput");
    const mostrarTudoBtn = document.getElementById("mostrarTudoBtn");
    const salvarLocalmenteBtn = document.getElementById('salvarLocalmenteBtn');
    const limparDadosLocaisBtn = document.getElementById('limparDadosLocaisBtn');
    const autoBackupToggle = document.getElementById('autoBackupToggle');
    const exportarClientesBtn = document.getElementById('exportarClientesBtn');
    const exportarReservasTXTBtn = document.getElementById('exportarReservasTXTBtn');
    const exportarReservasJSONBtn = document.getElementById('exportarReservasJSONBtn');
    const gerarRelatorioBtn = document.getElementById('gerarRelatorioBtn');
    const segurancaBtn = document.getElementById('segurancaBtn');
    const modalRelatorio = document.getElementById('modalRelatorio');
    const relatorioConteudoTexto = document.getElementById('relatorioConteudoTexto');
    const relatorioConteudoVisual = document.getElementById('relatorioConteudoVisual');
    const tooltip = document.getElementById('tooltip');
    const filtroResvCheckbox = document.getElementById("filtroResvCheckbox");
    
    // Referências para o Modal de Clientes
    const modalCliente = document.getElementById('modalCliente');
    const modalClienteTitulo = document.getElementById('modalClienteTitulo');
    const formCliente = document.getElementById('formCliente');
    const clienteOriginalNomeInput = document.getElementById('clienteOriginalNomeInput');
    const clienteNomeInput = document.getElementById('clienteNomeInput');
    const clienteWhatsInput = document.getElementById('clienteWhatsInput');
    const clientePaisInput = document.getElementById('clientePaisInput');
    const clienteTempoInput = document.getElementById('clienteTempoInput');
    const clienteUnidadeInput = document.getElementById('clienteUnidadeInput');
    const clienteStatusInput = document.getElementById('clienteStatusInput');
    const salvarClienteBtn = document.getElementById('salvarClienteBtn');
    
    // Botões de Gerenciamento de Cliente (agora no dropdown)
    const adicionarClienteBtn = document.getElementById('adicionarClienteBtn');
    const editarClienteBtn = document.getElementById('editarClienteBtn');
    const removerClienteBtn = document.getElementById('removerClienteBtn');
    
    // Configuração dos calendários
    const unidades = ["UN01", "UN02", "UN03"];
    const meses = [
        { nome: "Novembro", dias: 30, ano: 2025 },
        { nome: "Dezembro", dias: 31, ano: 2025 },
        { nome: "Janeiro", dias: 31, ano: 2026 },
        { nome: "Fevereiro", dias: 28, ano: 2026 },
        { nome: "Março", dias: 31, ano: 2026 },
        { nome: "Abril", dias: 30, ano: 2026 },
        { nome: "Maio", dias: 31, ano: 2026 }
    ];

    // FUNÇÕES AUXILIARES E DE UTILIDADE
    function showNotification(message, type = "info") {
        const notificationDiv = document.createElement("div");
        notificationDiv.textContent = message;
        notificationDiv.style.cssText = `
          position: fixed; top: 20px;
          right: 20px; padding: 10px 20px;
          border-radius: 5px; color: white; z-index: 3000; font-family: Arial, sans-serif;
          background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        `;
        document.body.appendChild(notificationDiv);
        setTimeout(() => notificationDiv.remove(), 3000);
    }

    // FUNÇÕES DE GERENCIAMENTO DE CLIENTES
    function abrirModalCliente(modo, cliente = null) {
        formCliente.reset();
        if (modo === 'editar' && cliente) {
            modalClienteTitulo.textContent = 'Editar Cliente';
            salvarClienteBtn.textContent = 'Salvar Alterações';
            clienteOriginalNomeInput.value = cliente.nome;
            clienteNomeInput.value = cliente.nome;
            clienteWhatsInput.value = cliente.whats || '';
            clientePaisInput.value = cliente.pais || '';
            clienteTempoInput.value = cliente.tempo || '';
            clienteUnidadeInput.value = cliente.unidade || '';
            clienteStatusInput.value = cliente.status || '';
        } else {
            modalClienteTitulo.textContent = 'Adicionar Novo Cliente';
            salvarClienteBtn.textContent = 'Adicionar Cliente';
            clienteOriginalNomeInput.value = '';
        }
        modalCliente.style.display = 'flex';
    }

    function fecharModalCliente() {
        modalCliente.style.display = 'none';
    }

    function handleFormClienteSubmit(event) {
        event.preventDefault();
        const nome = clienteNomeInput.value.trim();
        if (!nome) {
            showNotification("O nome do cliente é obrigatório.", "error");
            return;
        }

        const nomeOriginal = clienteOriginalNomeInput.value;
        if (clientes.some(c => c.nome.toLowerCase() === nome.toLowerCase() && c.nome !== nomeOriginal)) {
            showNotification("Já existe um cliente com este nome.", "error");
            return;
        }

        const dadosCliente = {
            nome: nome,
            whats: clienteWhatsInput.value.trim(),
            pais: clientePaisInput.value.trim(),
            tempo: clienteTempoInput.value.trim(),
            unidade: clienteUnidadeInput.value.trim(),
            status: clienteStatusInput.value.trim(),
            cor: "#000"
        };

        if (nomeOriginal) {
            const index = clientes.findIndex(c => c.nome === nomeOriginal);
            if (index > -1) {
                clientes[index] = dadosCliente;
                showNotification("Cliente atualizado com sucesso!", "success");
            }
        } else {
            clientes.push(dadosCliente);
            showNotification("Cliente adicionado com sucesso!", "success");
        }
        
        preencherListaClientes(clientes);
        clienteSelect.value = dadosCliente.nome;
        clienteSelecionado = dadosCliente.nome;
        editarClienteBtn.disabled = false;
        removerClienteBtn.disabled = false;
        aplicarFiltros();
        salvarDadosLocalmente();
        fecharModalCliente();
    }

    function preencherListaClientes(lista) {
        const valorSelecionadoAnteriormente = clienteSelect.value;
        clienteSelect.innerHTML = "<option value=\"\">-- Todos os Clientes --</option>";
        
        let listaFiltrada = lista;
        if (filtroResvCheckbox.checked) {
            listaFiltrada = lista.filter(cliente => cliente.status && cliente.status.trim().toUpperCase() === 'RESV');
        }
        
        listaFiltrada.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(cliente => {
            const option = document.createElement("option");
            option.value = cliente.nome;
            option.textContent = `${cliente.nome} (${cliente.whats || 's/n'})`;
            clienteSelect.appendChild(option);
        });
        
        if ([...clienteSelect.options].some(opt => opt.value === valorSelecionadoAnteriormente)) {
            clienteSelect.value = valorSelecionadoAnteriormente;
        }
    }

    function coletarDadosDeReservas() {
        const todasAsReservas = [];
        document.querySelectorAll('.dia').forEach(dia => {
            const { entrada, saida, hospedado, unidade, mes, ano, dia: diaNum } = dia.dataset;
            if (entrada || saida || hospedado) {
                todasAsReservas.push({ unidade, mes, ano, dia: diaNum, entrada: entrada || null, saida: saida || null, hospedado: hospedado || null });
            }
        });
        return todasAsReservas;
    }

    function baixarArquivo(conteudo, nomeArquivo, tipo = 'text/plain') {
        try {
            const blob = new Blob([conteudo], { type: tipo });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error("Erro ao baixar arquivo:", error);
            showNotification("Ocorreu um erro ao tentar gerar o arquivo.", "error");
        }
    }
    
    // LÓGICA DE GERENCIAMENTO DE DADOS (LOCAL STORAGE)
    function salvarDadosLocalmente() {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY_RESERVAS, JSON.stringify(coletarDadosDeReservas()));
            localStorage.setItem(LOCAL_STORAGE_KEY_CLIENTES, JSON.stringify(clientes));
            showNotification("Progresso salvo localmente!", "success");
        } catch (error) {
            console.error("Erro ao salvar dados:", error);
            showNotification("Erro ao salvar dados localmente.", "error");
        }
    }

    function carregarDadosLocais() {
        const dadosClientes = localStorage.getItem(LOCAL_STORAGE_KEY_CLIENTES);
        if (dadosClientes) {
            clientes = JSON.parse(dadosClientes);
            preencherListaClientes(clientes);
        }

        const dadosReservas = localStorage.getItem(LOCAL_STORAGE_KEY_RESERVAS);
        if (dadosReservas) {
            const reservas = JSON.parse(dadosReservas);
            reservas.forEach(reserva => {
                const diaDiv = document.querySelector(`.dia[data-unidade="${reserva.unidade}"][data-mes="${reserva.mes}"][data-dia="${reserva.dia}"]`);
                if (diaDiv) {
                    diaDiv.dataset.entrada = reserva.entrada || "";
                    diaDiv.dataset.saida = reserva.saida || "";
                    diaDiv.dataset.hospedado = reserva.hospedado || "";
                    atualizarVisual(diaDiv);
                }
            });
        }
        const autoBackupPref = localStorage.getItem('autoBackupEnabled');
        if (autoBackupPref === 'true') {
            autoBackupToggle.checked = true;
        }
    }

    function limparDadosLocais() {
        if (confirm("Você tem certeza que deseja apagar TODAS as reservas e clientes salvos localmente? Esta ação não pode ser desfeita.")) {
            localStorage.removeItem(LOCAL_STORAGE_KEY_RESERVAS);
            localStorage.removeItem(LOCAL_STORAGE_KEY_CLIENTES);
            showNotification("Dados locais foram limpos. A página será recarregada.", "info");
            setTimeout(() => window.location.reload(), 1500);
        }
    }
    
    // LÓGICA DE IMPORTAÇÃO E EXPORTAÇÃO
    function importarListaClientes(texto) {
        try {
            const linhas = texto.split("\n").filter(l => l.trim());
            const novosClientes = linhas.map(linha => {
                const [nome, whats, pais, tempo, unidade, status] = linha.split("-");
                return { nome: nome.trim(), whats, pais, tempo, unidade, status, cor: "#000" };
            });
            novosClientes.forEach(nc => {
                if (!clientes.some(c => c.nome === nc.nome)) {
                    clientes.push(nc);
                }
            });
            preencherListaClientes(clientes);
            showNotification("Clientes importados com sucesso!", "success");
            if(autoBackupToggle.checked) salvarDadosLocalmente();
        } catch (err) {
            showNotification("Erro ao importar clientes. Verifique o formato do arquivo.", "error");
            console.error("Erro ao importar clientes:", err);
        }
    }

    function importarReservas(jsonString) {
        try {
            const reservasImportadas = JSON.parse(jsonString);
            if (!Array.isArray(reservasImportadas)) throw new Error("O arquivo não é uma lista de reservas válida.");
            reservasImportadas.forEach(reserva => {
                const diaDiv = document.querySelector(`.dia[data-unidade="${reserva.unidade}"][data-mes="${reserva.mes}"][data-dia="${reserva.dia}"]`);
                if(diaDiv){
                    diaDiv.dataset.entrada = reserva.entrada || "";
                    diaDiv.dataset.saida = reserva.saida || "";
                    diaDiv.dataset.hospedado = reserva.hospedado || "";
                    atualizarVisual(diaDiv);
                }
            });
            showNotification("Reservas importadas com sucesso!", "success");
            if(autoBackupToggle.checked) salvarDadosLocalmente();
        } catch(err) {
            showNotification("Erro ao importar reservas. Verifique se o arquivo JSON é válido.", "error");
            console.error("Erro ao importar reservas:", err);
        }
    }
    
    function exportarListaClientes() {
        if (clientes.length === 0) return showNotification("Nenhum cliente para exportar.", "info");
        const conteudo = clientes.map(c => `${c.nome}-${c.whats || ''}-${c.pais || ''}-${c.tempo || ''}-${c.unidade || ''}-${c.status || ''}`).join('\n');
        baixarArquivo(conteudo, 'clientes_exportados.txt');
    }

    function exportarReservasJSON() {
        const dados = coletarDadosDeReservas();
        if (dados.length === 0) return showNotification("Nenhuma reserva para exportar.", "info");
        const conteudo = JSON.stringify(dados, null, 2);
        baixarArquivo(conteudo, 'reservas_exportadas.json', 'application/json');
    }

    function exportarReservasTXT() {
        const dados = coletarDadosDeReservas();
        if (dados.length === 0) return showNotification("Nenhuma reserva para exportar.", "info");
        let conteudo = "UNIDADE;DATA;TIPO;CLIENTE\n";
        dados.forEach(r => {
            const data = `${r.ano}-${String(meses.findIndex(m => m.nome === r.mes) + 1).padStart(2, '0')}-${String(r.dia).padStart(2, '0')}`;
            if (r.hospedado) conteudo += `${r.unidade};${data};HOSPEDADO;${r.hospedado}\n`;
            if (r.entrada) conteudo += `${r.unidade};${data};ENTRADA;${r.entrada}\n`;
            if (r.saida) conteudo += `${r.unidade};${data};SAIDA;${r.saida}\n`;
        });
        baixarArquivo(conteudo, 'reservas_exportadas.txt');
    }

    // LÓGICA DOS RELATÓRIOS DE OCUPAÇÃO (sem alterações)
    function analisarOcupacaoDosDias() { /* ...código existente sem alterações... */ return {};}
    function gerarRelatorioDetalhado() { /* ...código existente sem alterações... */ }
    function gerarRelatorioVisual() { /* ...código existente sem alterações... */ }

    // LÓGICA DE INTERAÇÃO COM O CALENDÁRIO
    function registrarReserva(dia) {
        if (!clienteSelecionado) return showNotification("Selecione um cliente para fazer uma reserva.", "error");
        const cliente = clientes.find(c => c.nome === clienteSelecionado);
        if (!cliente) return;
        let { entrada, saida, hospedado } = dia.dataset;
        if (hospedado && hospedado !== cliente.nome) {
            return showNotification("Este dia já está ocupado por outro cliente.", "error");
        } else if (entrada === cliente.nome && saida === cliente.nome) {
            dia.dataset.entrada = "";
            dia.dataset.saida = "";
            dia.dataset.hospedado = "";
        } else if (entrada === cliente.nome && !saida) {
            dia.dataset.hospedado = cliente.nome;
            dia.dataset.entrada = "";
            dia.dataset.saida = "";
        } else if (hospedado === cliente.nome) {
            dia.dataset.saida = cliente.nome;
            dia.dataset.entrada = "";
            dia.dataset.hospedado = "";
        } else if (saida === cliente.nome && !entrada) {
            dia.dataset.entrada = "";
            dia.dataset.saida = "";
            dia.dataset.hospedado = "";
        } else if (!entrada && !saida && !hospedado) {
            dia.dataset.entrada = cliente.nome;
        } else if (entrada && entrada !== cliente.nome && !saida) {
            dia.dataset.saida = cliente.nome;
        } else if (saida && saida !== cliente.nome && !entrada) {
            dia.dataset.entrada = cliente.nome;
        } else if (entrada && entrada !== cliente.nome && saida && saida !== cliente.nome) {
            return showNotification("Este dia já está ocupado por outros clientes.", "error");
        }
        atualizarVisual(dia);
        if (autoBackupToggle.checked) salvarDadosLocalmente();
    }

    function limparDia(dia) {
        dia.dataset.entrada = "";
        dia.dataset.saida = "";
        dia.dataset.hospedado = "";
        atualizarVisual(dia);
        if (autoBackupToggle.checked) salvarDadosLocalmente();
    }
    
    function atualizarVisual(dia) {
        const d = dia.dataset.dia;
        const { entrada, saida, hospedado } = dia.dataset;
        dia.className = "dia";
        
        const clienteEntrada = clientes.find(c => c.nome === entrada);
        const clienteSaida = clientes.find(c => c.nome === saida);
        const clienteHospedado = clientes.find(c => c.nome === hospedado);

        let content = `<strong>${d}</strong>`;

        if (hospedado && clienteHospedado) {
            dia.classList.add("hospedado");
            const prefixo = clienteHospedado.nome.slice(0, 3).toUpperCase();
            const sufixo = clienteHospedado.whats ? clienteHospedado.whats.slice(-4) : 'S/N';
            content = `<strong>${d} 🟢</strong><div>${prefixo}-${sufixo}-H</div>`;
        } else if (entrada && saida && entrada !== saida) {
            dia.classList.add("dupla");
            let registroCompacto = '';
            if (clienteSaida) {
                const prefixo = clienteSaida.nome.slice(0, 3).toUpperCase();
                const sufixo = clienteSaida.whats ? clienteSaida.whats.slice(-4) : 'S/N';
                registroCompacto += `<div>🔴 ${prefixo}-${sufixo}-S</div>`;
            }
            if (clienteEntrada) {
                const prefixo = clienteEntrada.nome.slice(0, 3).toUpperCase();
                const sufixo = clienteEntrada.whats ? clienteEntrada.whats.slice(-4) : 'S/N';
                registroCompacto += `<div>🔵 ${prefixo}-${sufixo}-E</div>`;
            }
            content = `<strong>${d} 🔄</strong>${registroCompacto}`;
        } else if (entrada && clienteEntrada) {
            dia.classList.add("entrada");
            const prefixo = clienteEntrada.nome.slice(0, 3).toUpperCase();
            const sufixo = clienteEntrada.whats ? clienteEntrada.whats.slice(-4) : 'S/N';
            content = `<strong>${d} 🔵</strong><div>${prefixo}-${sufixo}-E</div>`;
        } else if (saida && clienteSaida) {
            dia.classList.add("saida");
            const prefixo = clienteSaida.nome.slice(0, 3).toUpperCase();
            const sufixo = clienteSaida.whats ? clienteSaida.whats.slice(-4) : 'S/N';
            content = `<strong>${d} 🔴</strong><div>${prefixo}-${sufixo}-S</div>`;
        }
        dia.innerHTML = content;

        if (segurancaAtivada) dia.classList.add('seguranca-ativada');
    }

    function gerenciarTooltip(event) { /* ...código existente sem alterações... */ }
    function hideTooltip() { tooltip.style.display = 'none'; }

    function aplicarFiltros() {
        const clienteFiltro = clienteSelect.value;
        const unidadeFiltro = unidadeSelect.value;
        const mesFiltro = mesSelect.value;

        document.querySelectorAll('.unidade').forEach(unidadeDiv => {
            unidadeDiv.style.display = (unidadeFiltro === "" || unidadeDiv.id === unidadeFiltro) ? 'block' : 'none';
        });

        document.querySelectorAll('.mes').forEach(mesDiv => {
            const mesVisivel = mesDiv.closest('.unidade').style.display === 'block';
            mesDiv.style.display = (mesVisivel && (mesFiltro === "" || mesDiv.dataset.mes === mesFiltro)) ? 'block' : 'none';
        });

        document.querySelectorAll('.dia').forEach(diaDiv => {
            const { entrada, saida, hospedado } = diaDiv.dataset;
            const clientesDoDia = [entrada, saida, hospedado].filter(Boolean);
            const mesVisivel = diaDiv.closest('.mes').style.display === 'block';

            let matchCliente = true;
            if (clienteFiltro) {
                matchCliente = clientesDoDia.includes(clienteFiltro);
            } else if (filtroResvCheckbox.checked) {
                if (clientesDoDia.length === 0) {
                    matchCliente = false;
                } else {
                    matchCliente = clientesDoDia.some(nomeCliente => {
                        const detalhes = clientes.find(c => c.nome === nomeCliente);
                        return detalhes && detalhes.status && detalhes.status.trim().toUpperCase() === 'RESV';
                    });
                }
            }
            
            if (mesVisivel && matchCliente) {
                diaDiv.classList.remove('filtered-out');
                if (clienteFiltro) diaDiv.classList.add("filtered-in");
                else diaDiv.classList.remove("filtered-in");
            } else {
                diaDiv.classList.add('filtered-out');
                diaDiv.classList.remove('filtered-in');
            }
        });
    }

    function criarCalendario() { /* ...código existente sem alterações... */ }
    
    function handleCalendarClick(event) {
        const diaDiv = event.target.closest('.dia');
        if (!diaDiv) return;

        if (segurancaAtivada) {
            showNotification("Modo de segurança ativado. Não é possível alterar o calendário.", "info");
            return;
        }

        if (event.type === 'dblclick' || (event.type === 'contextmenu' && event.button === 2)) {
            event.preventDefault();
            limparDia(diaDiv);
        } else if (clienteSelecionado) {
            registrarReserva(diaDiv);
        } else {
            event.stopPropagation();
            gerenciarTooltip(event);
        }
    }
    
    
// INICIALIZAÇÃO
    // Funções de relatório omitidas para brevidade na documentação, mas presentes no código.


    function gerarRelatorioDetalhado() {
        relatorioConteudoTexto.innerHTML = '';
        const todasReservas = coletarDadosDeReservas();
        if (todasReservas.length === 0) {
            relatorioConteudoTexto.innerHTML = '<p>Nenhuma reserva registrada para gerar o relatório.</p>';
            return;
        }
        const reservasPorCliente = {};
        todasReservas.forEach(reserva => {
            const clienteNome = reserva.entrada || reserva.saida || reserva.hospedado;
            if (!clienteNome) return;
            const clienteDetalhes = clientes.find(c => c.nome === clienteNome);
            if (!clienteDetalhes) return;
            const clienteKey = `${clienteNome}_${reserva.unidade}`;
            if (!reservasPorCliente[clienteKey]) {
                reservasPorCliente[clienteKey] = { nome: clienteNome, whats: clienteDetalhes.whats, unidade: reserva.unidade, mes: reserva.mes, reservas: [] };
            }
            reservasPorCliente[clienteKey].reservas.push(reserva);
        });

        const agrupadoPorUnidadeMes = {};
        for (const key in reservasPorCliente) {
            const res = reservasPorCliente[key];
            if (!agrupadoPorUnidadeMes[res.unidade]) {
                agrupadoPorUnidadeMes[res.unidade] = {};
            }
            if (!agrupadoPorUnidadeMes[res.unidade][res.mes]) {
                agrupadoPorUnidadeMes[res.unidade][res.mes] = [];
            }
            res.reservas.sort((a, b) => {
                const dateA = new Date(a.ano, meses.findIndex(m => m.nome === a.mes), a.dia);
                const dateB = new Date(b.ano, meses.findIndex(m => m.nome === b.mes), b.dia);
                return dateA - dateB;
            });
            const primeiraEntrada = res.reservas[0];
            const ultimaSaida = res.reservas[res.reservas.length - 1];
            const dataEntrada = new Date(primeiraEntrada.ano, meses.findIndex(m => m.nome === primeiraEntrada.mes), primeiraEntrada.dia);
            const dataSaida = new Date(ultimaSaida.ano, meses.findIndex(m => m.nome === ultimaSaida.mes), ultimaSaida.dia);
            const diffTime = Math.abs(dataSaida - dataEntrada);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const noites = diffDays;
            const texto = `${res.nome} (Whats: ${res.whats}): Entra (${String(dataEntrada.getDate()).padStart(2, '0')}/${String(dataEntrada.getMonth() + 1).padStart(2, '0')}/${dataEntrada.getFullYear()}) - Sai (${String(dataSaida.getDate()).padStart(2, '0')}/${String(dataSaida.getMonth() + 1).padStart(2, '0')}/${dataSaida.getFullYear()}) = ${noites} noites`;
            agrupadoPorUnidadeMes[res.unidade][res.mes].push(texto);
        }
        const diasTotais = meses.reduce((total, mes) => total + mes.dias, 0);
        const ocupacao = analisarOcupacaoDosDias();
        const htmlResumoGeral = document.createElement('div');
        htmlResumoGeral.innerHTML = `<h3>Resumo de Ocupação Geral</h3>`;
        for (const unidade of unidades) {
            const diasOcupados = Object.keys(ocupacao[unidade] || {}).length;
            const diasLivres = diasTotais - diasOcupados;
            const porcentagemOcupacao = (diasOcupados / diasTotais * 100).toFixed(2);
            htmlResumoGeral.innerHTML += `
                <p><strong>Unidade: ${unidade}</strong></p>
                <p>Dias Ocupados: ${diasOcupados} de ${diasTotais}</p>
                <p>Dias Livres: ${diasLivres} de ${diasTotais}</p>
                <p>Porcentagem de Ocupação: ${porcentagemOcupacao}%</p>
            `;
        }
        relatorioConteudoTexto.appendChild(htmlResumoGeral);
        relatorioConteudoTexto.innerHTML += '<hr>';
        for (const unidade of unidades) {
            if (agrupadoPorUnidadeMes[unidade]) {
                const htmlUnidade = document.createElement('div');
                htmlUnidade.classList.add('unidade-relatorio');
                htmlUnidade.innerHTML = `<h4>Reservas da Unidade ${unidade}</h4>`;
                const ul = document.createElement('ul');
                for (const mes of meses) {
                    if (agrupadoPorUnidadeMes[unidade][mes.nome]) {
                        const htmlMes = document.createElement('div');
                        htmlMes.innerHTML = `<h5>${mes.nome}</h5>`;
                        agrupadoPorUnidadeMes[unidade][mes.nome].forEach(resumo => {
                            const li = document.createElement('li');
                            li.textContent = resumo;
                            ul.appendChild(li);
                        });
                        htmlUnidade.appendChild(htmlMes);
                    }
                }
                htmlUnidade.appendChild(ul);
                relatorioConteudoTexto.appendChild(htmlUnidade);
            }
        }
    }

    function gerarRelatorioVisual() {
        relatorioConteudoVisual.innerHTML = '';
        const ocupacao = analisarOcupacaoDosDias();
        const diasDaSemana = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        
        for (const unidade of unidades) {
            const containerUnidade = document.createElement('div');
            containerUnidade.classList.add('unidade-relatorio');
            containerUnidade.innerHTML = `<h4>Unidade: ${unidade}</h4>`;
            
            for (const mesInfo of meses) {
                const containerMes = document.createElement('div');
                containerMes.classList.add('mes-relatorio');
                containerMes.innerHTML = `<h5>${mesInfo.nome} ${mesInfo.ano}</h5>`;
                
                const gridDias = document.createElement('div');
                gridDias.classList.add('dias-relatorio');

                diasDaSemana.forEach(dia => {
                    const headerDia = document.createElement('div');
                    headerDia.classList.add('dia-relatorio', 'header');
                    headerDia.textContent = dia;
                    gridDias.appendChild(headerDia);
                });
                
                const primeiroDia = new Date(mesInfo.ano, meses.findIndex(m => m.nome === mesInfo.nome), 1).getDay();
                for (let i = 0; i < primeiroDia; i++) {
                    gridDias.innerHTML += '<div></div>';
                }

                for (let i = 1; i <= mesInfo.dias; i++) {
                    const diaDiv = document.createElement('div');
                    diaDiv.classList.add('dia-relatorio');
                    diaDiv.textContent = i;
                    
                    const chaveData = `${mesInfo.ano}-${mesInfo.nome}-${i}`;
                    const diaOcupacao = ocupacao[unidade][chaveData];
                    
                    if (diaOcupacao) {
                        if (diaOcupacao.entrada && diaOcupacao.saida) {
                            diaDiv.classList.add('troca');
                        } else if (diaOcupacao.hospedado || diaOcupacao.entrada) {
                            diaDiv.classList.add('noite-ocupada');
                        } else if (diaOcupacao.saida) {
                            diaDiv.classList.add('checkout-apenas');
                        }
                    }
                    gridDias.appendChild(diaDiv);
                }
                containerMes.appendChild(gridDias);
                containerUnidade.appendChild(containerMes);
            }
            relatorioConteudoVisual.appendChild(containerUnidade);
        }
    }


   function analisarOcupacaoDosDias() {
        const ocupacao = {};
        unidades.forEach(u => ocupacao[u] = {});
        document.querySelectorAll('.dia').forEach(dia => {
            const { entrada, saida, hospedado, unidade, mes, ano, dia: diaNum } = dia.dataset;
            if (entrada || saida || hospedado) {
                const chaveData = `${ano}-${mes}-${diaNum}`;
                ocupacao[unidade][chaveData] = { entrada: !!entrada, saida: !!saida, hospedado: !!hospedado };
            }
        });
        return ocupacao;
    }


    criarCalendario = () => { container.innerHTML = ''; unidades.forEach(unidade => { const uDiv = document.createElement("div"); uDiv.classList.add("unidade"); uDiv.id = unidade; uDiv.innerHTML = `<h2>${unidade}</h2>`; meses.forEach(mes => { const mDiv = document.createElement("div"); mDiv.classList.add("mes"); mDiv.dataset.mes = mes.nome; mDiv.innerHTML = `<h3>${mes.nome} ${mes.ano}</h3><div class="dias"></div>`; const dCont = mDiv.querySelector(".dias"); for (let i = 1; i <= mes.dias; i++) { const dDiv = document.createElement("div"); dDiv.classList.add("dia"); dDiv.innerHTML = `<strong>${i}</strong>`; Object.assign(dDiv.dataset, {dia: i, mes: mes.nome, ano: mes.ano, unidade: unidade}); dCont.appendChild(dDiv); } uDiv.appendChild(mDiv); }); container.appendChild(uDiv); }); };
    
    criarCalendario();
    carregarDadosLocais();
    aplicarFiltros();
    
    // LISTENERS DE EVENTOS
    document.addEventListener('DOMContentLoaded', () => { carregarDadosLocais(); aplicarFiltros(); });

    clienteSelect.addEventListener('change', () => {
        clienteSelecionado = clienteSelect.value;
        if (clienteSelect.value) {
            editarClienteBtn.disabled = false;
            removerClienteBtn.disabled = false;
        } else {
            editarClienteBtn.disabled = true;
            removerClienteBtn.disabled = true;
        }
        aplicarFiltros();
    });
    unidadeSelect.addEventListener('change', aplicarFiltros);
    mesSelect.addEventListener('change', aplicarFiltros);
    filtroResvCheckbox.addEventListener('change', () => {
        preencherListaClientes(clientes);
        clienteSelecionado = clienteSelect.value;
        aplicarFiltros();
    });

    mostrarTudoBtn.addEventListener('click', () => {
        clienteSelect.value = "";
        unidadeSelect.value = "";
        mesSelect.value = "";
        filtroResvCheckbox.checked = false;
        preencherListaClientes(clientes);
        clienteSelecionado = clienteSelect.value;
        editarClienteBtn.disabled = true;
        removerClienteBtn.disabled = true;
        aplicarFiltros();
    });
    salvarLocalmenteBtn.addEventListener('click', salvarDadosLocalmente);
    limparDadosLocaisBtn.addEventListener('click', limparDadosLocais);
    segurancaBtn.addEventListener('click', () => {
      segurancaAtivada = !segurancaAtivada;
      segurancaBtn.textContent = segurancaAtivada ? "🔒 Segurança Ativada" : "🔓 Segurança Desativada";
      segurancaBtn.classList.toggle('seguranca-ativada', segurancaAtivada);
      document.querySelectorAll('.dia').forEach(dia => dia.classList.toggle('seguranca-ativada', segurancaAtivada));
      showNotification(segurancaAtivada ? "Modo de segurança ativado." : "Modo de segurança desativado.", "info");
    });

    const ajudaBtn = document.getElementById("ajudaBtn");
    const modalAjuda = document.getElementById("modalAjuda");
    ajudaBtn.addEventListener('click', () => modalAjuda.style.display = 'flex');
    modalAjuda.querySelector(".modal-close-btn").addEventListener('click', () => modalAjuda.style.display = 'none');

    document.addEventListener('click', gerenciarTooltip);
    container.addEventListener('click', handleCalendarClick);
    container.addEventListener('dblclick', handleCalendarClick);
    container.addEventListener('contextmenu', handleCalendarClick);

    importarClientesBtn.addEventListener('click', () => importarClientesInput.click());
    importarReservasBtn.addEventListener('click', () => importarReservasInput.click());
    importarClientesInput.addEventListener('change', e => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = ev => importarListaClientes(ev.target.result); r.readAsText(f); } e.target.value = null; });
    importarReservasInput.addEventListener('change', e => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = ev => importarReservas(ev.target.result); r.readAsText(f); } e.target.value = null; });

    exportarClientesBtn.addEventListener('click', exportarListaClientes);
    exportarReservasJSONBtn.addEventListener('click', exportarReservasJSON);
    exportarReservasTXTBtn.addEventListener('click', exportarReservasTXT);

    // LISTENERS PARA GERENCIAMENTO DE CLIENTES
    adicionarClienteBtn.addEventListener('click', () => abrirModalCliente('adicionar'));
    editarClienteBtn.addEventListener('click', () => { const nome = clienteSelect.value; if(nome) { const cliente = clientes.find(c => c.nome === nome); if(cliente) abrirModalCliente('editar', cliente); } });
    removerClienteBtn.addEventListener('click', () => {
        const nome = clienteSelect.value;
        if (!nome) return;
        if (confirm(`Tem certeza que deseja remover o cliente "${nome}"?`)) {
            clientes = clientes.filter(c => c.nome !== nome);
            preencherListaClientes(clientes);
            salvarDadosLocalmente();
            showNotification("Cliente removido.", "info");
            clienteSelect.value = "";
            clienteSelecionado = null;
            editarClienteBtn.disabled = true;
            removerClienteBtn.disabled = true;
            aplicarFiltros();
        }
    });


// Listener para o botão de gerar relatório
    gerarRelatorioBtn.addEventListener('click', () => {
        gerarRelatorioDetalhado();
        gerarRelatorioVisual();
        
        // Abre o modal e define a primeira aba como ativa por padrão
        modalRelatorio.style.display = 'flex';
        const primeiraAba = document.querySelector('.tab-btn');
        const primeiroConteudo = document.getElementById(primeiraAba.dataset.target);
        
        document.querySelectorAll('.tab-btn, .report-content').forEach(el => el.classList.remove('active'));
        primeiraAba.classList.add('active');
        primeiroConteudo.classList.add('active');
    });

    // Listener para fechar o modal do relatório
    modalRelatorio.querySelector('.modal-close-btn').addEventListener('click', () => {
        modalRelatorio.style.display = 'none';
    });

    // Listeners para as abas do relatório (Texto e Visual)
    document.querySelectorAll('.modal-tabs .tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Remove a classe 'active' de todas as abas e conteúdos
            document.querySelectorAll('.modal-tabs .tab-btn, .report-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Adiciona 'active' à aba clicada e ao conteúdo correspondente
            button.classList.add('active');
            document.getElementById(button.dataset.target).classList.add('active');
        });
    });


    formCliente.addEventListener('submit', handleFormClienteSubmit);
    modalCliente.querySelector('.modal-close-btn').addEventListener('click', fecharModalCliente);
})();

</script>
</body>
</html>